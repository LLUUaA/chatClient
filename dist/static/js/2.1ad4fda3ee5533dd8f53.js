webpackJsonp([2],{ADc4:function(t,n,e){t.exports=e.p+"static/img/img-coding.8dabd62.svg"},CtDR:function(t,n){},QXW3:function(t,n,e){"use strict";var s=["😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","😗","😙","😚","🙂","🤗","🤩","🤔","🤨","😐","😑","😶","🙄","😏","🤐","😴","😜","😓","😭","😲","🤞","🖖","👌","👍","👎","✊","👊","💔"],a={name:"inputComponent",data:function(){return{inputVal:null,showEmoji:null,emojiList:s}},props:{value:[String,Number]},mounted:function(){},methods:{send:function(){this.$emit("send",encodeURIComponent(this.inputVal||""))},handleInput:function(t){this.$emit("input",t)},chooseEmoji:function(t){this.inputVal=(this.inputVal||"")+t},clear:function(){this.inputVal=""}}},i={render:function(){var t=this,n=this,e=n.$createElement,s=n._self._c||e;return s("div",{staticClass:"input-wrap flex"},[s("el-input",{attrs:{clearable:"",placeholder:"请输入内容"},on:{input:n.handleInput},nativeOn:{keyup:function(t){return"button"in t||!n._k(t.keyCode,"enter",13,t.key,"Enter")?n.send(t):null}},model:{value:n.inputVal,callback:function(t){n.inputVal=t},expression:"inputVal"}}),n._v(" "),s("div",{staticClass:"handle-warp flex"},[s("div",{staticClass:"icon"},[s("el-popover",{attrs:{placement:"top",title:"表情",width:"300",trigger:"click"},on:{show:function(){return t.showEmoji=!0},hide:function(){return t.showEmoji=!1}}},[s("i",{staticClass:"iconfont icon-emoji",attrs:{slot:"reference"},slot:"reference"}),n._v(" "),n._l(n.emojiList,function(t,e){return s("div",{key:e,staticClass:"emoji-item",on:{click:function(e){n.chooseEmoji(t)}}},[n._v(n._s(t))])})],2)],1),n._v(" "),s("div",{staticClass:"icon send-btn",on:{click:n.send}},[s("i",{staticClass:"iconfont icon-send"})])])],1)},staticRenderFns:[]};var o=e("VU/8")(a,i,!1,function(t){e("pHlk")},"data-v-85db6a2e",null).exports,r=e("IxXs"),c=e.n(r),u=(e("oysA"),e("8cdv"),{name:"chatComponent",components:{inputComponent:o},data:function(){return{defaultIcon:c.a}},props:{chatHistory:Array,showAvatar:Boolean,chatInfo:null},watch:{chatHistory:{handler:function(t,n){var e=this;this.$nextTick().then(function(){e.chatScorllToBottom()})},deep:!1},chatInfo:function(t,n){console.log("chatInfo",t,n)}},methods:{sendMessage:function(t){this.$emit("send",t)},handleInput:function(t){this.$emit("input",t)},clearInput:function(){this.$refs.inputRef.clear()},chatScorllToBottom:function(t){try{var n=document.querySelector("#chatWrap"),e=n.scrollHeight,s=n.scrollTop,a=null,i=Math.floor(e/10);t?a=window.requestAnimationFrame(function t(){n.scrollTop=s,e>=s?a=window.requestAnimationFrame(t):window.cancelAnimationFrame(a),s+=i}):n.scrollTop=e}catch(t){}}}}),l={render:function(){var t=this,n=t.$createElement,s=t._self._c||n;return t.chatInfo?s("div",{staticClass:"chat-box friend-box"},[s("div",{staticClass:"item flex"},[s("div",{staticClass:"avatar"},[s("img",{directives:[{name:"imgLoad",rawName:"v-imgLoad",value:{src:t.chatInfo.avatar||t.chatInfo.avatar,errorSrc:t.defaultIcon},expression:"{src: chatInfo.avatar || chatInfo.avatar, errorSrc: defaultIcon}"}]})]),t._v(" "),s("div",{staticClass:"right"},[s("div",{staticClass:"m-t flex"},[s("span",{staticClass:"name"},[t._v(t._s(t.chatInfo.nickName||t.chatInfo.name))])]),t._v(" "),s("div",{staticClass:"content"},[t._v(t._s(t.chatInfo.content||t.chatInfo.signature||t.chatInfo.postscript||""))])])]),t._v(" "),s("div",{staticClass:"chat-container"},[s("div",{staticClass:"chat-wrap",attrs:{id:"chatWrap"}},[t._l(t.chatHistory,function(n,e){return[s("div",{key:n.id,staticClass:"chat-item",class:n.isSender?"sender":""},[s("div",[!n.isSender&&t.showAvatar?s("div",{staticClass:"avatar room-avatar"},[n.userInfo.avatar?s("img",{attrs:{src:n.userInfo.avatar}}):t._e(),t._v(" "),s("span",[t._v(t._s(n.userInfo.surname))])]):t._e(),t._v(" "),s("div",{staticClass:"content"},[t._v(t._s(t._f("decodeContent")(n.content)))])]),t._v(" "),s("div",{staticClass:"time"},[t._v(t._s(t._f("dateTime")(n.time)))])])]}),t._v(" "),t.chatHistory&&0===t.chatHistory.length?s("div",{staticClass:"no-more"},[t._v("没有聊天内容，说点什么吧")]):t._e()],2),t._v(" "),s("inputComponent",{ref:"inputRef",on:{input:t.handleInput,send:t.sendMessage}})],1)]):s("div",{staticClass:"chat-box friend-box no-chat-wrap"},[s("img",{attrs:{src:e("ADc4")}}),t._v(" "),s("p",{staticClass:"no-more"},[t._v("点击聊天窗口进行对话")])])},staticRenderFns:[]};var d=e("VU/8")(u,l,!1,function(t){e("CtDR")},"data-v-2d316b94",null);n.a=d.exports},X8Cn:function(t,n,e){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var s=e("Xxa5"),a=e.n(s),i=e("exGp"),o=e.n(i),r=e("mJEs"),c=e("QXW3"),u=e("8cdv"),l=[],d=null,h=null,f=null;function m(t){return t?Math.ceil(new Date(t).getTime()/1e3):Math.ceil((new Date).getTime()/1e3)}var v={name:"single",components:{friendsComponent:r.a,chatComponent:c.a},data:function(){return{currentIndex:null,friendList:null,showItem:null,chatList:null}},destroyed:function(){this.destroyedListener(l)},mounted:function(){var t=this;return o()(a.a.mark(function n(){return a.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.getOnlineList();case 2:t.listenMessage(),t.listenTyping(),t.listenOnlieStatus();case 5:case"end":return n.stop()}},n,t)}))()},methods:{showChat:function(t){var n=this;return o()(a.a.mark(function e(){var s;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=n.friendList[t]){e.next=4;break}return e.abrupt("return");case 4:return n.showItem=s,e.next=7,n.getChatById(s.uid);case 7:n.chatList=e.sent,n.myListener.emit(u.EVENT_HAS_READ_MSG,s.notReadCount,u.SINGLE),n.friendList[t].notReadCount=0,d=m(n.chatList.slice(-1)[0].time),e.next=15;break;case 13:e.prev=13,e.t0=e.catch(0);case 15:case"end":return e.stop()}},e,n,[[0,13]])}))()},handleInput:function(t){h||m()-d>30||(this.WS.send(u.TYPING,{uid:this.showItem.uid}),h=!0)},listenTyping:function(){var t=this,n=this.myListener.on(u.EVENT_TYPING,function(n){var e=t.showItem;e&&e.uid===n.uid&&(t.$set(t.showItem,"content","对方正在输入.."),f&&clearTimeout(f),f=setTimeout(function(){t.$set(t.showItem,"content",null)},15e3))});l.push(n)},listenOnlieStatus:function(){var t=this,n=this.myListener.on(u.EVENT_ONLNIE_STATUS,function(n){for(var e=n.uid,s=t.friendList,a=0;a<s.length;a++)if(s[a].uid===e){t.$set(t.friendList[a],"onlineStatus",n.status);break}});l.push(n)},listenMessage:function(){var t=this,n=this.myListener.on(u.EVENT_NEW_SINGLE_MSG,function(n){if(t.chatList||(t.chatList=[]),t.friendList&&t.friendList.length){if(t.showItem&&n.sendUid===t.showItem.uid)return t.chatList.push(n),t.getChatById(n.sendUid),t.myListener.emit(u.EVENT_HAS_READ_MSG,1,u.SINGLE),d=m(),h=!1,clearTimeout(f),void t.$set(t.showItem,"content",null);for(var e=0;e<t.friendList.length;e++){var s=t.friendList[e];if(s.uid===n.sendUid){s.notReadCount++,s.last=n,t.$set(t.friendList,e,s);break}}}});l.push(n)},getChatById:function(t){var n=this;return o()(a.a.mark(function e(){var s;return a.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.axios({url:"message/history",params:{uid:t}});case 2:return s=e.sent,e.abrupt("return",s||[]);case 4:case"end":return e.stop()}},e,n)}))()},getOnlineList:function(){var t=this;return o()(a.a.mark(function n(){var e;return a.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.axios({url:"friend/list",method:"get"});case 2:return e=n.sent,t.friendList=(e||[]).filter(function(t){return t&&t.uid}),n.abrupt("return");case 5:case"end":return n.stop()}},n,t)}))()},sendMessage:function(t){var n=this;this.showItem?t?this.axios({url:"message/send",method:"post",data:{uid:this.showItem.uid,content:t}}).then(function(t){n.chatList||(n.chatList=[]),n.$refs.chatRef.clearInput(),n.chatList.push(t)},function(){n.$message({showClose:!0,message:"消息发送失败，请重试",type:"error"})}):this.$message({showClose:!0,message:"请输入内容",type:"warning"}):this.$message({showClose:!0,message:"还没有选择好友哦",type:"warning"})}}},p={render:function(){var t=this.$createElement,n=this._self._c||t;return n("div",{staticClass:"online-left"},[n("friendsComponent",{attrs:{datas:this.friendList},on:{show:this.showChat}}),this._v(" "),n("chatComponent",{ref:"chatRef",attrs:{chatHistory:this.chatList,chatInfo:this.showItem},on:{input:this.handleInput,send:this.sendMessage}})],1)},staticRenderFns:[]};var _=e("VU/8")(v,p,!1,function(t){e("glpp")},"data-v-11de94fb",null);n.default=_.exports},glpp:function(t,n){},mJEs:function(t,n,e){"use strict";var s=e("IxXs"),a=e.n(s),i=(e("8cdv"),{name:"friendsComponent",data:function(){return{currentIndex:null}},props:{datas:{type:Array,default:null},toViewPath:{type:String,default:"/index/search"},defalutIcon:{type:null,default:a.a},noDataText:{type:String,default:"还没有好友哦，添加好友进行聊天吧"}},watch:{},methods:{toSearchView:function(){this.$router.push(this.toViewPath)},clickMenu:function(t){this.$emit("clickMenu",t)},showChat:function(t){this.$emit("show",t),this.currentIndex=t}}}),o={render:function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("div",{staticClass:"friend-box"},[t._l(t.datas,function(n,s){return[e("div",{key:n.uid,staticClass:"item hover flex",class:{current:s===t.currentIndex,"not-read":n.notReadCount>0},attrs:{"data-count":n.notReadCount},on:{click:function(n){t.showChat(s)}}},[e("div",{staticClass:"avatar",class:{online:n.onlineStatus,offline:0===n.onlineStatus}},[e("img",{directives:[{name:"imgLoad",rawName:"v-imgLoad",value:{src:n.avatar||n.logo,errorSrc:t.defalutIcon},expression:"{src: data.avatar || data.logo, errorSrc: defalutIcon}"}]})]),t._v(" "),e("div",{staticClass:"right"},[e("div",{staticClass:"m-t flex"},[e("span",{staticClass:"name"},[t._v(t._s(n.nickName||n.name||""))]),t._v(" "),e("span",{staticClass:"time"},[t._v(t._s(t._f("time")(n.last.time)))])]),t._v(" "),e("div",{staticClass:"content"},[t._v(t._s(t._f("decodeContent")(n.last.content)))]),t._v(" "),n.showMenu?e("i",{staticClass:"menu el-icon-more",on:{click:function(e){e.stopPropagation(),t.clickMenu(n)}}}):t._e()])])]}),t._v(" "),t.datas?0===t.datas.length?e("div",{staticClass:"no-more"},[e("span",[t._v(t._s(t.noDataText))]),t._v(" "),e("el-button",{attrs:{type:"text"},on:{click:t.toSearchView}},[t._v("去添加")])],1):t._e():e("div",{directives:[{name:"loading",rawName:"v-loading",value:!0,expression:"true"}],staticClass:"loading-wrap",attrs:{"element-loading-text":"拼命加载中","element-loading-background":"#f7fcff"}})],2)},staticRenderFns:[]};var r=e("VU/8")(i,o,!1,function(t){e("tUyB")},"data-v-03bbce8e",null);n.a=r.exports},oysA:function(t,n,e){t.exports=e.p+"static/img/icon-group-avatar.a745a61.svg"},pHlk:function(t,n){},tUyB:function(t,n){}});